# Custom Drill Builder API Contract

## Data Model

### CustomDrill
Stored in a subcollection `custom_drills` under the event document: `events/{event_id}/custom_drills/{drill_id}`.

```python
class CustomDrill(BaseModel):
    id: str                   # UUID, generated by backend
    event_id: str             # Parent event ID
    name: str                 # Display name (e.g., "40m Shuttle")
    unit: str                 # "sec", "mph", "in", "reps", "%", or custom string
    category: str             # "Speed", "Agility", "Power", "Skill", "Conditioning", "Physical"
    lower_is_better: bool     # True for sprints, False for jumps/reps
    min_val: float            # For normalization (0 score anchor)
    max_val: float            # For normalization (500 score anchor)
    description: Optional[str] # Helper text for evaluators
    created_at: datetime      # UTC timestamp
    created_by: str           # User ID of creator
```

### Response Schema
API responses will include a `locked` boolean flag derived from the event's Live Entry status.

```python
class CustomDrillResponse(CustomDrill):
    is_locked: bool           # True if event.live_entry_active is True
```

---

## API Endpoints

All endpoints require authentication and `organizer` role.

### 1. Create Custom Drill
**POST** `/api/leagues/{league_id}/events/{event_id}/custom-drills`

**Request Body:**
```json
{
  "name": "Shuttle Run",
  "unit": "sec",
  "category": "Agility",
  "lower_is_better": true,
  "min_val": 4.0,
  "max_val": 10.0,
  "description": "Standard 5-10-5 shuttle"
}
```

**Validation:**
- `event_id` must exist.
- Event must NOT have Live Entry active.
- `min_val` < `max_val`.
- `name` must be unique within the event (case-insensitive check).

**Response:** `201 Created`
```json
{
  "id": "drill_12345...",
  "event_id": "evt_987...",
  ...
}
```

### 2. List Custom Drills
**GET** `/api/leagues/{league_id}/events/{event_id}/custom-drills`

**Response:** `200 OK`
```json
{
  "custom_drills": [
    {
      "id": "drill_123...",
      "name": "Shuttle Run",
      "unit": "sec",
      "category": "Agility",
      "lower_is_better": true,
      "min_val": 4.0,
      "max_val": 10.0,
      "is_locked": false
    }
  ]
}
```

### 3. Update Custom Drill
**PUT** `/api/leagues/{league_id}/events/{event_id}/custom-drills/{drill_id}`

**Validation:**
- Event must NOT have Live Entry active (return 403 if active).
- Drill must exist.

**Request Body:** (Partial updates allowed)
```json
{
  "name": "Pro Shuttle",
  "max_val": 12.0
}
```

**Response:** `200 OK` (Returns updated object)

### 4. Delete Custom Drill
**DELETE** `/api/leagues/{league_id}/events/{event_id}/custom-drills/{drill_id}`

**Validation:**
- Event must NOT have Live Entry active (return 403 if active).

**Response:** `204 No Content`

---

## Backend Implementation Notes

1.  **Locking Logic:**
    -   Endpoints check `event.live_entry_active` (or equivalent status field) before allowing POST/PUT/DELETE.
    -   If active, raise `HTTPException(409, detail="Cannot modify drills after Live Entry has started")`.

2.  **Firestore Structure:**
    -   Use `events/{event_id}/custom_drills` collection.
    -   (Optional) Duplicate to `leagues/{league_id}/events/{event_id}/custom_drills` if strict hierarchy is needed, but reading from global `events` collection is preferred for performance/simplicity in the Players view.

3.  **CSV Export:**
    -   When exporting player data, backend must fetch custom drills for the event and append them as dynamic columns.
    -   Header format: `custom_{drill_name_snake_case}`.

